<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>虛擬人物自動生成器 (雲端版)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 1.5rem; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .modal-overlay { transition: opacity 0.3s ease; }
    .modal-content { transition: transform 0.3s ease; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <header class="text-center mb-8">
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">虛擬人物自動生成器</h1>
      <p class="text-gray-500 mt-2">您的資料將被即時儲存至雲端，可在任何裝置上同步存取。</p>
    </header>

    <div class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-md flex justify-center space-x-4 mb-8">
      <button id="generateBtn" class="bg-indigo-600 text-white font-bold py-3 px-8 hover:bg-indigo-700 transition-colors duration-200" disabled>新增一位人物</button>
      <button id="clearBtn" class="bg-red-600 text-white font-bold py-3 px-8 hover:bg-red-700 transition-colors duration-200" disabled>全部清除</button>
    </div>

    <div id="status" class="text-center text-gray-500 my-4">正在連接雲端資料庫...</div>
    <div id="userIdDisplay" class="text-center text-gray-400 text-xs my-2"></div>

    <main id="character-grid" class="card-grid"></main>

    <footer class="text-center mt-12 text-gray-400 text-sm">
      <p>此資料庫由 AI 生成，僅供參考。</p>
    </footer>
  </div>

  <!-- Modal -->
  <div id="prayerModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
    <div id="modalOverlay" class="absolute inset-0 bg-black bg-opacity-50 modal-overlay"></div>
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col modal-content transform scale-95">
      <div class="flex justify-between items-center p-4 border-b">
        <h3 id="modalTitle" class="text-lg font-bold text-gray-800">禱告內容</h3>
        <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <div id="modalBody" class="p-6 overflow-y-auto">
        <p id="prayerContent" class="text-gray-700 whitespace-pre-wrap leading-relaxed"></p>
      </div>
      <div class="p-4 border-t flex justify-end">
        <button id="copyPrayerBtn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 hover:bg-gray-300 transition-colors duration-200">
          複製內容
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK & App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, writeBatch, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0_B_n_stXFqrBd2KPoEHc4pr8Bpd4rlQ",
      authDomain: "virtual-character-generator.firebaseapp.com",
      projectId: "virtual-character-generator",
      storageBucket: "virtual-character-generator.firebasestorage.app",
      messagingSenderId: "492764039412",
      appId: "1:492764039412:web:fe05d1755c85b95f5af6a1",
      measurementId: "G-N5EPNFRHJN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let allChars = [], charsCol;
    const statusDiv = document.getElementById('status');
    const uidDiv = document.getElementById('userIdDisplay');
    const genBtn = document.getElementById('generateBtn');
    const clrBtn = document.getElementById('clearBtn');

    function updateStatus() {
      statusDiv.textContent = allChars.length
        ? `目前雲端資料庫中共有 ${allChars.length} 位人物。`
        : '雲端資料庫是空的，請生成新的人物。';
    }

    async function initAuth() {
      try {
        await signInAnonymously(auth);
      } catch (e) {
        statusDiv.textContent = '無法連接資料庫，3秒後重試…';
        setTimeout(initAuth, 3000);
      }
    }

    onAuthStateChanged(auth, user => {
      if (!user) return initAuth();
      uidDiv.textContent = `您的雲端ID: ${user.uid}`;
      charsCol = collection(db, `artifacts/${firebaseConfig.projectId}/users/${user.uid}/characters`);
      const q = query(charsCol, orderBy('createdAt'));
      onSnapshot(q, snap => {
        allChars = snap.docs.map(d=>({id:d.id, ...d.data()}));
        updateStatus();
        genBtn.disabled = false;
        clrBtn.disabled = false;
      });
    });

    // 這裡可接 generate/clear/render 邏輯…
  </script>
</body>
</html>
