<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虛擬人物自動生成器 (個人雲端版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 1.5rem; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <header class="text-center mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">虛擬人物自動生成器</h1>
        <p class="text-gray-500 mt-2">您的資料將被即時儲存至您的個人雲端，可在任何裝置上同步存取。</p>
    </header>

    <div class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-md flex justify-center space-x-4 mb-8">
        <button id="generateBtn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200" disabled>
            新增一位人物
        </button>
        <button id="clearBtn" class="bg-red-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200" disabled>
            全部刪除
        </button>
    </div>

    <div id="status" class="text-center text-gray-500 my-4">正在連接您的雲端資料庫...</div>
    <div id="userIdDisplay" class="text-center text-gray-400 text-xs my-2"></div>

    <main id="character-grid" class="card-grid"><!-- 角色卡片 --></main>

    <footer class="text-center mt-12 text-gray-400 text-sm">此資料庫由 AI 生成，僅供參考。</footer>
</div>

<!-- 禱告內容 Modal -->
<div id="prayerModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
    <div id="modalOverlay" class="absolute inset-0 bg-black bg-opacity-50 modal-overlay"></div>
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col modal-content transform scale-95">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 id="modalTitle" class="text-lg font-bold text-gray-800">禱告內容</h3>
            <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="p-6 overflow-y-auto"><p id="prayerContent" class="text-gray-700 whitespace-pre-wrap leading-relaxed"></p></div>
        <div class="p-4 border-t flex justify-end">
            <button id="copyPrayerBtn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors duration-200">複製內容</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDocs, writeBatch, doc, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0_B_n_stXFqrBd2KPoEHc4pr8Bpd4rlQ",
        authDomain: "virtual-character-generator.firebaseapp.com",
        projectId: "virtual-character-generator",
        storageBucket: "virtual-character-generator.appspot.com",
        messagingSenderId: "492764039412",
        appId: "1:492764039412:web:fe05d1755c85b95faf6a1",
        measurementId: "G-N5EPNFRHJN"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 啟用離線快取
    enableIndexedDbPersistence(db).catch(err => console.warn("離線快取失敗:", err.code));

    // 本地持久化匿名登入
    setPersistence(auth, browserLocalPersistence)
        .then(() => signInAnonymously(auth))
        .catch(err => console.error("匿名登入失敗:", err));

    const dataPools = {
        names: ["小明", "小美", "志強", "怡君", "家豪", "佩珊", "偉倫", "雅婷", "信宏", "淑芬"],
        genders: ["男", "女"],
        ages: [18, 22, 25, 28, 30, 35, 40, 45, 50, 60],
        jobs: ["學生", "老師", "工程師", "設計師", "醫生", "護士", "業務", "家庭主婦", "退休人士", "自由業"],
        interests: ["閱讀", "運動", "旅遊", "音樂", "美食", "攝影", "繪畫", "寫作", "園藝", "手作"]
    };
    const choice = arr => arr[Math.floor(Math.random() * arr.length)];
    const randint = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    function generateCharacter() {
        return {
            name: choice(dataPools.names),
            gender: choice(dataPools.genders),
            age: choice(dataPools.ages),
            job: choice(dataPools.jobs),
            interest: choice(dataPools.interests),
            createdAt: serverTimestamp()
        };
    }

    function generatePrayerFromTemplate(character) {
        return `親愛的天父，感謝祢賜給我們${character.name}（${character.gender}，${character.age}歲），祂是一位${character.job}，熱愛${character.interest}。求祢保守祂在生活與工作中都能經歷祢的恩典與平安，並在每一天都充滿喜樂與盼望。奉主耶穌的名禱告，阿們。`;
    }

    let allGeneratedCharacters = [];
    let charactersCollection;
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const grid = document.getElementById('character-grid');
    const statusDiv = document.getElementById('status');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const modal = document.getElementById('prayerModal');
    const modalOverlay = document.getElementById('modalOverlay');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const modalTitle = document.getElementById('modalTitle');
    const prayerContent = document.getElementById('prayerContent');
    const copyPrayerBtn = document.getElementById('copyPrayerBtn');

    function updateStatus() {
        statusDiv.textContent = allGeneratedCharacters.length
            ? `目前雲端資料庫中總共有 ${allGeneratedCharacters.length} 位人物。`
            : '雲端資料庫是空的，請生成新的人物。';
    }
    function openModal() { modal.classList.remove('hidden'); document.body.classList.add('overflow-hidden'); setTimeout(() => { modalOverlay.classList.remove('opacity-0'); modal.querySelector('.modal-content').classList.remove('scale-95'); }, 10); }
    function closeModal() { modalOverlay.classList.add('opacity-0'); modal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); }, 300); }

    closeModalBtn.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', closeModal);
    copyPrayerBtn.addEventListener('click', () => {
        const text = prayerContent.textContent;
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            copyPrayerBtn.textContent = '已複製！';
            setTimeout(() => { copyPrayerBtn.textContent = '複製內容'; }, 1200);
        });
    });

    function renderAllCards(chars) {
        grid.innerHTML = '';
        if (!chars.length) return;
        chars.forEach(character => {
            const card = document.createElement('div');
            card.className = "bg-white rounded-xl shadow-md p-6 flex flex-col space-y-2 hover:shadow-lg transition cursor-pointer";
            card.innerHTML = `
                <div class="text-xl font-bold text-indigo-700">${character.name}</div>
                <div class="text-gray-600">性別：${character.gender}</div>
                <div class="text-gray-600">年齡：${character.age}</div>
                <div class="text-gray-600">職業：${character.job}</div>
                <div class="text-gray-600">興趣：${character.interest}</div>
                <div class="text-xs text-gray-400 mt-2">${character.createdAt && character.createdAt.toDate ? character.createdAt.toDate().toLocaleString() : ''}</div>
            `;
            card.addEventListener('click', () => handleCardClick(character));
            grid.appendChild(card);
        });
    }

    function handleCardClick(character) {
        modalTitle.textContent = `${character.name} 的禱告內容`;
        prayerContent.textContent = generatePrayerFromTemplate(character);
        openModal();
    }

    generateBtn.addEventListener('click', async () => {
        if (!charactersCollection) return;
        generateBtn.disabled = true;
        try {
            const newChar = generateCharacter();
            await addDoc(charactersCollection, newChar);
        } catch (err) {
            alert('新增人物失敗：' + err.message);
        }
        generateBtn.disabled = false;
    });

    clearBtn.addEventListener('click', async () => {
        if (!charactersCollection) return;
        if (!confirm('確定要刪除全部人物嗎？此動作無法復原。')) return;
        clearBtn.disabled = true;
        try {
            const snap = await getDocs(charactersCollection);
            const batch = writeBatch(db);
            snap.forEach(docu => batch.delete(doc(charactersCollection, docu.id)));
            await batch.commit();
        } catch (err) {
            alert('刪除失敗：' + err.message);
        }
        clearBtn.disabled = false;
    });

    onAuthStateChanged(auth, user => {
        if (user) {
            const uid = user.uid;
            userIdDisplay.textContent = `您的專屬雲端ID: ${uid}`;
            charactersCollection = collection(db, `characters/${uid}/people`);
            const q = query(charactersCollection, orderBy('createdAt', 'asc'));
            onSnapshot(q, snap => {
                allGeneratedCharacters = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                renderAllCards(allGeneratedCharacters);
                updateStatus();
            }, err => console.error('監聽失敗:', err));
            generateBtn.disabled = false;
            clearBtn.disabled = false;
        }
    });
</script>
</body>
</html>
