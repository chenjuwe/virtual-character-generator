<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虛擬人物自動生成器 (個人雲端版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 1.5rem; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <header class="text-center mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">虛擬人物自動生成器</h1>
        <p class="text-gray-500 mt-2">您的資料將被即時儲存至您的個人雲端，可在任何裝置上同步存取。</p>
    </header>

    <div class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-md flex justify-center space-x-4 mb-8">
        <button id="generateBtn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200" disabled>
            新增一位人物
        </button>
        <button id="clearBtn" class="bg-red-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200" disabled>
            全部清除
        </button>
    </div>

    <div id="status" class="text-center text-gray-500 my-4">正在連接您的雲端資料庫...</div>
    <div id="userIdDisplay" class="text-center text-gray-400 text-xs my-2"></div>

    <main id="character-grid" class="card-grid"></main>

    <footer class="text-center mt-12 text-gray-400 text-sm">此資料庫由 AI 生成，僅供參考。</footer>
</div>

<div id="prayerModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
    <div id="modalOverlay" class="absolute inset-0 bg-black bg-opacity-50 modal-overlay"></div>
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col modal-content transform scale-95">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 id="modalTitle" class="text-lg font-bold text-gray-800">禱告內容</h3>
            <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="p-6 overflow-y-auto"><p id="prayerContent" class="text-gray-700 whitespace-pre-wrap leading-relaxed"></p></div>
        <div class="p-4 border-t flex justify-end">
            <button id="copyPrayerBtn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors duration-200">複製內容</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDocs, writeBatch, doc, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0_B_n_stXFqrBd2KPoEHc4pr8Bpd4rlQ",
        authDomain: "virtual-character-generator.firebaseapp.com",
        projectId: "virtual-character-generator",
        storageBucket: "virtual-character-generator.appspot.com",
        messagingSenderId: "492764039412",
        appId: "1:492764039412:web:fe05d1755c85b95faf6a1",
        measurementId: "G-N5EPNFRHJN"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    enableIndexedDbPersistence(db).catch(err => console.warn("離線快取失敗:", err.code));
    setPersistence(auth, browserLocalPersistence)
        .then(() => signInAnonymously(auth))
        .catch(err => console.error("匿名登入失敗:", err));

    const dataPools = {
        surnames_zh: ['陳','林','黃','張','李','王','吳','劉','蔡','楊','許','鄭','謝','郭','洪','曾','邱','廖','賴','周','蘇','葉','莊','江'],
        surnames_en: ['Chen','Lin','Huang','Chang','Lee','Wang','Wu','Liu','Tsai','Yang','Hsu','Cheng','Hsieh','Kuo','Hung','Tseng','Chiu','Liao','Lai','Chou','Su','Yeh','Chuang','Chiang'],
        given_names_male_zh: ['志明','家豪','俊傑','建宏','文雄','俊賢','志偉','承翰','冠宇','宇軒','品睿','宥廷','宇恩','立揚','向陽','宥翔','柏翰','宗翰','冠霖'],
        given_names_female_zh: ['怡君','淑芬','美玲','雅婷','淑惠','靜宜','心雅','詩涵','品妍','詠晴','諾雅','安琪','向晴','宥寧','佳穎','欣妤','子晴'],
        given_names_male_en: ['David','Michael','Jason','Kevin','Daniel','Brian','Alex','Ethan','Ryan','Leo','Jeff','Hank','Wayne','Gary','Peter','Steven'],
        given_names_female_en: ['Emily','Jessica','Michelle','Tiffany','Grace','Sarah','Cindy','Sharon','Ann','Vivian','Jean','Fiona','Irene','Claire','Yvonne'],
        education_jobs: {
            '高中職畢':[{title:'美髮設計師',economic:'在連鎖髮廊工作，收入靠底薪加抽成。'},...],
            '專科畢':[{...}],
            '大學畢':[{...}],
            '碩士畢':[{...}],
            '在學生':[{title:'研究生',economic:'靠微薄助理費，學業壓力大。'}]
        },
        /* 其餘 health_issues, hobbies, communication_styles, strengths, weaknesses, faith_types, life_events, fears, dreams */
    };
    const choice = arr => arr[Math.floor(Math.random()*arr.length)];
    const randint = (min,max) => Math.floor(Math.random()*(max-min+1))+min;

    function generateCharacter(){ /* 完整實作同原始範例 */ }
    function generatePrayerFromTemplate(ch){ /* 同原始範例 */ }

    let allGeneratedCharacters=[];
    let charactersCollection;
    const generateBtn=document.getElementById('generateBtn');
    const clearBtn=document.getElementById('clearBtn');
    const grid=document.getElementById('character-grid');
    const statusDiv=document.getElementById('status');
    const userIdDisplay=document.getElementById('userIdDisplay');
    const modal=document.getElementById('prayerModal');
    const modalOverlay=document.getElementById('modalOverlay');
    const closeModalBtn=document.getElementById('closeModalBtn');
    const modalTitle=document.getElementById('modalTitle');
    const prayerContent=document.getElementById('prayerContent');
    const copyPrayerBtn=document.getElementById('copyPrayerBtn');

    function updateStatus(){ statusDiv.textContent=allGeneratedCharacters.length?`目前雲端資料庫中總共有 ${allGeneratedCharacters.length} 位人物。`:'雲端資料庫是空的，請生成新的人物。'; }
    function openModal(){ /*...*/ }
    function closeModal(){ /*...*/ }
    closeModalBtn.addEventListener('click',closeModal);
    modalOverlay.addEventListener('click',closeModal);
    copyPrayerBtn.addEventListener('click',()=>{/*...*/});
    function handleCardClick(ch){/*...*/}
    generateBtn.addEventListener('click',async()=>{/*...*/});
    clearBtn.addEventListener('click',async()=>{/*...*/});
    function renderAllCards(chars){/*...*/}

    onAuthStateChanged(auth,user=>{
        if(user){
            const uid=user.uid;
            userIdDisplay.textContent=`您的專屬雲端ID: ${uid}`;
            charactersCollection=collection(db,`characters/${uid}/people`);
            const q=query(charactersCollection,orderBy('createdAt','asc'));
            onSnapshot(q,snap=>{allGeneratedCharacters=snap.docs.map(d=>({...d.data(),id:d.id}));renderAllCards(allGeneratedCharacters);updateStatus();});
            generateBtn.disabled=false;clearBtn.disabled=false;
        }
    });
</script>
</body>
</html>
