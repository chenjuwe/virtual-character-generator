<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虛擬人物自動生成器 (個人雲端版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 1.5rem; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <header class="text-center mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">虛擬人物自動生成器</h1>
        <p class="text-gray-500 mt-2">您的資料將被即時儲存至您的個人雲端，可在任何裝置上同步存取。</p>
    </header>

    <div class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-md flex justify-center space-x-4 mb-8">
        <button id="generateBtn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200" disabled>
            新增一位人物
        </button>
        <button id="clearBtn" class="bg-red-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200" disabled>
            全部刪除
        </button>
    </div>

    <div id="status" class="text-center text-gray-500 my-4">正在連接您的雲端資料庫...</div>
    <div id="userIdDisplay" class="text-center text-gray-400 text-xs my-2"></div>

    <main id="character-grid" class="card-grid"></main>

    <footer class="text-center mt-12 text-gray-400 text-sm">此資料庫由 AI 生成，僅供參考。</footer>
</div>

<div id="prayerModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDocs, writeBatch, doc, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 您的 Firebase 設定...
    const firebaseConfig = {
        apiKey: "AIzaSyC0_B_n_stXFqrBd2KPoEHc4pr8Bpd4rlQ",
        authDomain: "virtual-character-generator.firebaseapp.com",
        projectId: "virtual-character-generator",
        storageBucket: "virtual-character-generator.appspot.com",
        messagingSenderId: "492764039412",
        appId: "1:492764039412:web:fe05d1755c85b95faf6a1",
        measurementId: "G-N5EPNFRHJN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- 省略部分已有的程式碼 (Firebase 初始化, DOM 元素宣告等) ---
    enableIndexedDbPersistence(db).catch(err => console.warn("離線快取失敗:", err.code));
    setPersistence(auth, browserLocalPersistence).then(() => signInAnonymously(auth)).catch(err => console.error("匿名登入失敗:", err));

    let allGeneratedCharacters = [];
    let charactersCollection;
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const grid = document.getElementById('character-grid');
    const statusDiv = document.getElementById('status');
    const userIdDisplay = document.getElementById('userIdDisplay');
    // ... 其他 DOM 元素

    // --- [重要] 這裡需要您提供 `generateCharacter` 的具體實作 ---
    // 為了讓卡片能顯示資料，我先假設 generateCharacter() 會回傳像這樣的物件：
    // { name: "陳小明", age: 30, gender: "男", occupation: "工程師", personality: "內向、謹慎" }
    function generateCharacter() {
        // 這是一個範例，請用您自己的 `generateCharacter` 函式替換
        const names = ["林家豪", "陳怡君", "黃文雄", "張美玲", "王志明"];
        const occupations = ["工程師", "設計師", "行銷企劃", "老師", "自由工作者"];
        const personalities = ["開朗、外向", "內向、謹慎", "富有創造力", "務實、可靠"];
        const choice = arr => arr[Math.floor(Math.random() * arr.length)];
        return {
            name: choice(names),
            age: Math.floor(Math.random() * 40) + 20,
            gender: Math.random() > 0.5 ? "男" : "女",
            occupation: choice(occupations),
            personality: choice(personalities)
        };
    }
    
    function generatePrayerFromTemplate(character) { /* 您的原始 generatePrayerFromTemplate 函式 */ }
    function handleCardClick(character) { /* 您的原始 handleCardClick 函式 */ }

    // --- 「全部刪除」按鈕的事件監聽 (已優化) ---
    clearBtn.addEventListener('click', async () => {
        const isConfirmed = window.confirm('您確定要刪除所有人物嗎？這個操作無法復原！');
        if (!isConfirmed) return;
        
        generateBtn.disabled = true;
        clearBtn.disabled = true;
        try {
            const snapshot = await getDocs(query(charactersCollection));
            const batch = writeBatch(db);
            snapshot.docs.forEach(docToDelete => batch.delete(docToDelete.ref));
            await batch.commit();
        } catch (error) {
            console.error('刪除失敗:', error);
            alert('刪除失敗，請檢查網路連線或稍後再試。');
        } finally {
            generateBtn.disabled = false;
            clearBtn.disabled = false;
        }
    });

    // --- 「新增人物」按鈕的事件監聽 (已優化) ---
    generateBtn.addEventListener('click', async () => {
        generateBtn.disabled = true;
        try {
            const newCharacter = generateCharacter();
            await addDoc(charactersCollection, { ...newCharacter, createdAt: serverTimestamp() });
        } catch (error) {
            console.error("新增失敗:", error);
            alert("新增人物失敗，請稍後再試。");
        } finally {
            // 注意：這裡不再需要 re-enable 按鈕，因為 onSnapshot 會處理 UI 更新，
            // 而按鈕的狀態應該由 onAuthStateChanged 管理。為求簡單，我們暫時保留它。
            generateBtn.disabled = false; 
        }
    });
    
    // --- [修正] 補上渲染人物卡片的完整邏輯 ---
    function renderAllCards(chars) {
        grid.innerHTML = ''; // 清空現有卡片

        if (chars.length === 0) {
            // 如果沒有任何角色，顯示引導訊息
            grid.innerHTML = `
                <div class="col-span-full text-center py-16 px-6 bg-white rounded-lg shadow-md">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
                    </svg>
                    <h3 class="mt-2 text-lg font-medium text-gray-900">資料庫是空的</h3>
                    <p class="mt-1 text-sm text-gray-500">試著點擊上方的「新增一位人物」來開始吧！</p>
                </div>
            `;
        } else {
            // [這裡就是補上的核心邏輯]
            // 否則，遍歷所有角色資料，並為每一個角色創建一個卡片
            chars.forEach(character => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-lg overflow-hidden flex flex-col';
                
                // 卡片內容
                card.innerHTML = `
                    <div class="p-6 flex-grow">
                        <div class="flex justify-between items-start">
                            <h2 class="text-2xl font-bold text-gray-800">${character.name || '未命名'}</h2>
                            <span class="bg-indigo-100 text-indigo-800 text-sm font-medium px-2.5 py-0.5 rounded-full">${character.gender || '?'}</span>
                        </div>
                        <p class="text-gray-600 mt-1">${character.age || '?'} 歲，${character.occupation || '職業不詳'}</p>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <h4 class="font-semibold text-gray-700">個性特質：</h4>
                            <p class="text-gray-600 mt-1">${character.personality || '尚無描述'}</p>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 border-t">
                        <button class="view-prayer-btn w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                            查看禱告內容
                        </button>
                    </div>
                `;

                // 為「查看禱告內容」按鈕添加事件監聽
                const viewPrayerBtn = card.querySelector('.view-prayer-btn');
                viewPrayerBtn.addEventListener('click', () => {
                    // 這邊需要您提供 handleCardClick 的實作
                    // 例如：handleCardClick(character);
                    console.log("查看人物:", character.name);
                    alert(`正在查看 ${character.name} 的禱告內容 (此為示意)`);
                });

                // 將完成的卡片加入到格線中
                grid.appendChild(card);
            });
        }
    }

    // --- onAuthStateChanged 監聽使用者登入狀態 ---
    onAuthStateChanged(auth, user => {
        if (user) {
            const uid = user.uid;
            userIdDisplay.textContent = `您的專屬雲端ID: ${uid}`;
            charactersCollection = collection(db, `characters/${uid}/people`);
            
            const q = query(charactersCollection, orderBy('createdAt', 'asc'));
            
            onSnapshot(q, snap => {
                allGeneratedCharacters = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                renderAllCards(allGeneratedCharacters); // 呼叫優化後的渲染函式
                
                // 更新狀態文字
                const statusText = allGeneratedCharacters.length
                    ? `目前雲端資料庫中總共有 ${allGeneratedCharacters.length} 位人物。`
                    : '雲端資料庫是空的，請生成新的人物。';
                statusDiv.textContent = statusText;

            }, err => console.error('監聽失敗:', err));

            generateBtn.disabled = false;
            clearBtn.disabled = false;
        } else {
            statusDiv.textContent = '無法連接至雲端，請重新整理頁面。';
            generateBtn.disabled = true;
            clearBtn.disabled = true;
        }
    });
</script>

</body>
</html>