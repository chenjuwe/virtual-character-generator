<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虛擬人物自動生成器 (個人雲端版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 1.5rem;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">虛擬人物自動生成器</h1>
            <p class="text-gray-500 mt-2">您的資料將被即時儲存至您的個人雲端，可在任何裝置上同步存取。</p>
        </header>

        <div class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-md flex justify-center space-x-4 mb-8">
            <button id="generateBtn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200" disabled>
                新增一位人物
            </button>
            <button id="clearBtn" class="bg-red-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200" disabled>
                全部清除
            </button>
        </div>
        
        <div id="status" class="text-center text-gray-500 my-4">正在連接您的雲端資料庫...</div>
        <div id="userIdDisplay" class="text-center text-gray-400 text-xs my-2"></div>

        <main id="character-grid" class="card-grid">
            <!-- 人物卡片將由 JavaScript 動態生成於此 -->
        </main>
        
        <footer class="text-center mt-12 text-gray-400 text-sm">
            <p>此資料庫由 AI 生成，僅供參考。</p>
        </footer>
    </div>

    <!-- 禱告內容 Modal -->
    <div id="prayerModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="modalOverlay" class="absolute inset-0 bg-black bg-opacity-50 modal-overlay"></div>
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col modal-content transform scale-95">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="modalTitle" class="text-lg font-bold text-gray-800">禱告內容</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="modalBody" class="p-6 overflow-y-auto">
                <p id="prayerContent" class="text-gray-700 whitespace-pre-wrap leading-relaxed"></p>
            </div>
             <div class="p-4 border-t flex justify-end">
                <button id="copyPrayerBtn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors duration-200">
                    複製內容
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase v10+
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, writeBatch, doc, serverTimestamp, orderBy, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ==============================================================================
        // !!! 您提供的 Firebase 設定已置於此處 !!!
        // ==============================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyC0_B_n_stXFqrBd2KPoEHc4pr8Bpd4rlQ",
            authDomain: "virtual-character-generator.firebaseapp.com",
            projectId: "virtual-character-generator",
            storageBucket: "virtual-character-generator.appspot.com",
            messagingSenderId: "492764039412",
            appId: "1:492764039412:web:fe05d1755c85b95faf6a1",
            measurementId: "G-N5EPNFRHJN"
        };
        // ==============================================================================

        // 初始化 Firebase App、Auth 與 Firestore
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 資料池與生成功能
        const dataPools = { /* ... 保留原有 dataPools 定義 ... */ };
        const choice = arr => arr[Math.floor(Math.random() * arr.length)];
        const randint = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        function generateCharacter() { /* ... 保留原有 generateCharacter 函式 ... */ }
        function generatePrayerFromTemplate(character) { /* ... 保留原有 generatePrayerFromTemplate 函式 ... */ }

        // UI 元素宣告
        const generateBtn = document.getElementById('generateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const grid = document.getElementById('character-grid');
        const statusDiv = document.getElementById('status');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const modal = document.getElementById('prayerModal');
        const modalOverlay = document.getElementById('modalOverlay');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalTitle = document.getElementById('modalTitle');
        const prayerContent = document.getElementById('prayerContent');
        const copyPrayerBtn = document.getElementById('copyPrayerBtn');

        // 啟用 Firestore 離線快取
        enableIndexedDbPersistence(db).catch(err => {
            console.warn("離線快取啟動失敗:", err.code);
        });

        // 設定匿名登入本地持久化，並執行匿名登入
        setPersistence(auth, browserLocalPersistence)
            .then(() => signInAnonymously(auth))
            .catch(error => {
                console.error("匿名登入失敗:", error);
                statusDiv.textContent = "無法連線至雲端，請稍後再試。";
            });

        // 更新狀態文字
        function updateStatus() {
            if (allGeneratedCharacters.length > 0) {
                statusDiv.textContent = `目前雲端資料庫中總共有 ${allGeneratedCharacters.length} 位人物。`;
            } else {
                statusDiv.textContent = '雲端資料庫是空的，請生成新的人物。';
            }
        }

        // 模態框開關
        function openModal() { /* ... 保留 ... */ }
        function closeModal() { /* ... 保留 ... */ }
        closeModalBtn.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', closeModal);
        copyPrayerBtn.addEventListener('click', () => { /* ... 保留 ... */ });

        // 處理卡片點擊
        function handleCardClick(character) { /* ... 保留 ... */ }

        // 生成新角色
        generateBtn.addEventListener('click', async () => { /* ... 保留 ... */ });

        // 清除所有角色
        clearBtn.addEventListener('click', async () => { /* ... 保留 ... */ });

        // 渲染角色卡片
        function renderAllCards(charactersToRender) { /* ... 保留 ... */ }

        // 監聽認證狀態
        onAuthStateChanged(auth, user => {
            if (user) {
                const userId = user.uid;
                userIdDisplay.textContent = `您的專屬雲端ID: ${userId}`;
                charactersCollection = collection(db, `characters/${userId}/people`);
                const q = query(charactersCollection, orderBy("createdAt", "asc"));
                onSnapshot(q, snapshot => {
                    allGeneratedCharacters = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    renderAllCards(allGeneratedCharacters);
                    updateStatus();
                }, err => {
                    console.error("監聽資料庫失敗:", err);
                    statusDiv.textContent = "無法監聽雲端資料庫更新。";
                });
                generateBtn.disabled = false;
                clearBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
