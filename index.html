<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虛擬人物自動生成器 (個人雲端版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 1.5rem; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <header class="text-center mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">虛擬人物自動生成器</h1>
        <p class="text-gray-500 mt-2">您的資料將被即時儲存至您的個人雲端，可在任何裝置上同步存取。</p>
    </header>

    <div class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-md flex justify-center space-x-4 mb-8">
        <button id="generateBtn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200" disabled>
            新增一位人物
        </button>
        <button id="clearBtn" class="bg-red-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200" disabled>
            全部刪除
        </button>
    </div>

    <div id="status" class="text-center text-gray-500 my-4">正在連接您的雲端資料庫...</div>
    <div id="userIdDisplay" class="text-center text-gray-400 text-xs my-2"></div>

    <main id="character-grid" class="card-grid"></main>

    <footer class="text-center mt-12 text-gray-400 text-sm">此資料庫由 AI 生成，僅供參考。</footer>
</div>

<div id="prayerModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
    <div id="modalOverlay" class="absolute inset-0 bg-black bg-opacity-50 modal-overlay"></div>
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col modal-content transform scale-95">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 id="modalTitle" class="text-lg font-bold text-gray-800">禱告內容</h3>
            <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="p-6 overflow-y-auto"><p id="prayerContent" class="text-gray-700 whitespace-pre-wrap leading-relaxed"></p></div>
        <div class="p-4 border-t flex justify-end">
            <button id="copyPrayerBtn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors duration-200">複製內容</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDocs, writeBatch, doc, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 您的 Firebase 設定...
    const firebaseConfig = {
        apiKey: "AIzaSyC0_B_n_stXFqrBd2KPoEHc4pr8Bpd4rlQ",
        authDomain: "virtual-character-generator.firebaseapp.com",
        projectId: "virtual-character-generator",
        storageBucket: "virtual-character-generator.appspot.com",
        messagingSenderId: "492764039412",
        appId: "1:492764039412:web:fe05d1755c85b95faf6a1",
        measurementId: "G-N5EPNFRHJN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    enableIndexedDbPersistence(db).catch(err => console.warn("離線快取失敗:", err.code));

    setPersistence(auth, browserLocalPersistence)
        .then(() => signInAnonymously(auth))
        .catch(err => console.error("匿名登入失敗:", err));

    const dataPools = { /* 您的原始 dataPools 資料 */ };
    const choice = arr => arr[Math.floor(Math.random() * arr.length)];
    const randint = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    function generateCharacter() { /* 您的原始 generateCharacter 函式 */ }
    function generatePrayerFromTemplate(character) { /* 您的原始 generatePrayerFromTemplate 函式 */ }

    // --- DOM 元素宣告 (省略以節省篇幅) ---
    let allGeneratedCharacters = [];
    let charactersCollection;
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const grid = document.getElementById('character-grid');
    const statusDiv = document.getElementById('status');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const modal = document.getElementById('prayerModal');
    const modalOverlay = document.getElementById('modalOverlay');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const modalTitle = document.getElementById('modalTitle');
    const prayerContent = document.getElementById('prayerContent');
    const copyPrayerBtn = document.getElementById('copyPrayerBtn');

    function updateStatus() { /* 原始 updateStatus 函式 */ }
    function openModal() { /* 原始 openModal 函式 */ }
    function closeModal() { /* 原始 closeModal 函式 */ }

    closeModalBtn.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', closeModal);
    copyPrayerBtn.addEventListener('click', () => { /* 原始複製處理 */ });

    function handleCardClick(character) { /* 原始 handleCardClick */ }

    // --- 新增按鈕事件 (建議加入 try...catch...finally) ---
    generateBtn.addEventListener('click', async () => {
        generateBtn.disabled = true;
        try {
            const newCharacter = generateCharacter();
            await addDoc(charactersCollection, { ...newCharacter, createdAt: serverTimestamp() });
        } catch (error) {
            console.error("新增失敗:", error);
            alert("新增人物失敗，請稍後再試。");
        } finally {
            generateBtn.disabled = false;
        }
    });

    // --- [優化 1] 為「全部刪除」增加防呆確認，並優化流程 ---
    clearBtn.addEventListener('click', async () => {
        // 增加防呆確認對話框
        const isConfirmed = window.confirm('您確定要刪除所有人物嗎？這個操作無法復原！');
        if (!isConfirmed) {
            return; // 如果使用者點擊「取消」，則中止操作
        }

        generateBtn.disabled = true;
        clearBtn.disabled = true;

        try {
            const q = query(charactersCollection);
            const snapshot = await getDocs(q);
            const batch = writeBatch(db);
            snapshot.docs.forEach(docToDelete => {
                batch.delete(docToDelete.ref);
            });
            await batch.commit();
        } catch (error) {
            console.error('刪除失敗:', error);
            alert('刪除失敗，請檢查網路連線或稍後再試。');
        } finally {
            generateBtn.disabled = false;
            clearBtn.disabled = false;
        }
    });
    
    // --- [優化 2] 優化初次使用的「空狀態」畫面 ---
    function renderAllCards(chars) {
        grid.innerHTML = ''; // 清空現有卡片

        if (chars.length === 0) {
            // 如果沒有任何角色，顯示引導訊息
            grid.innerHTML = `
                <div class="col-span-full text-center py-16 px-6 bg-white rounded-lg shadow-md">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
                    </svg>
                    <h3 class="mt-2 text-lg font-medium text-gray-900">資料庫是空的</h3>
                    <p class="mt-1 text-sm text-gray-500">試著點擊上方的「新增一位人物」來開始吧！</p>
                </div>
            `;
        } else {
            // 否則，渲染所有角色卡片
            // 這部分假設您已有渲染卡片的邏輯，請將其放入此處
            // 例如:
            // chars.forEach(character => {
            //     const card = document.createElement('div');
            //     card.className = '...'; // 卡片樣式
            //     card.innerHTML = `...`; // 卡片內容
            //     grid.appendChild(card);
            // });
        }
    }


    onAuthStateChanged(auth, user => {
        if (user) {
            const uid = user.uid;
            userIdDisplay.textContent = `您的專屬雲端ID: ${uid}`;
            charactersCollection = collection(db, `characters/${uid}/people`);
            
            const q = query(charactersCollection, orderBy('createdAt', 'asc'));
            
            onSnapshot(q, snap => {
                allGeneratedCharacters = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                renderAllCards(allGeneratedCharacters); // 呼叫優化後的渲染函式
                updateStatus(); // 假設您有此函式
            }, err => console.error('監聽失敗:', err));

            generateBtn.disabled = false;
            clearBtn.disabled = false;
            statusDiv.textContent = '已成功連接您的雲端資料庫。'; // 連線成功後更新狀態
        } else {
            statusDiv.textContent = '無法連接至雲端，請重新整理頁面。';
            generateBtn.disabled = true;
            clearBtn.disabled = true;
        }
    });

    // (請確認您有實作 `updateStatus`, `generateCharacter` 等函式的內容)
</script>

</body>
</html>